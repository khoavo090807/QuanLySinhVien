@model QuanLySinhVien.Models.DangKyHocPhan

@{
    ViewBag.Title = "Nhập/Sửa điểm sinh viên";
}

<div class="row mb-4">
    <div class="col-12">
        <h2 class="page-title">
            <i class="fas fa-edit"></i> Nhập/Sửa điểm cho sinh viên
        </h2>
    </div>
</div>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle"></i> @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-circle"></i> @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="card">
    <div class="card-header bg-primary text-white">
        <i class="fas fa-graduation-cap"></i> Thông tin sinh viên và môn học
    </div>
    <div class="card-body">
        <div class="row mb-4 p-3 bg-light rounded">
            <div class="col-md-6">
                <div class="mb-3">
                    <strong><i class="fas fa-user-circle text-primary"></i> Mã sinh viên:</strong>
                    <br />
                    <span class="badge bg-primary fs-6">@Model.MaSV</span>
                </div>
                <div class="mb-3">
                    <strong><i class="fas fa-user text-success"></i> Họ tên:</strong>
                    <br />
                    <span class="text-success">@Model.HoTenSV</span>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <strong><i class="fas fa-book text-info"></i> Mã lớp học phần:</strong>
                    <br />
                    <span class="badge bg-info fs-6">@Model.MaLHP</span>
                </div>
                <div class="mb-3">
                    <strong><i class="fas fa-bookmark text-warning"></i> Môn học:</strong>
                    <br />
                    <span class="text-warning">@Model.TenMH</span>
                </div>
            </div>
        </div>

        <hr />

        @using (Html.BeginForm("Edit", "DangKyHocPhan", FormMethod.Post))
        {
            @Html.AntiForgeryToken()
            <input type="hidden" name="MaSV" value="@Model.MaSV" />
            <input type="hidden" name="MaLHP" value="@Model.MaLHP" />

            <div class="row">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-check-circle text-success"></i> Điểm Chuyên Cần (10%)
                        </label>
                        <div class="input-group">
                            <input type="number" id="DiemChuyenCan" name="DiemChuyenCan"
                                   class="form-control" step="any" min="0" max="10"
                                   value="@(Model.DiemChuyenCan.HasValue ? Model.DiemChuyenCan.Value.ToString("0.##", System.Globalization.CultureInfo.InvariantCulture) : "")"
                                   placeholder="0.0" />
                            <span class="input-group-text">/10</span>
                        </div>
                        <small class="text-muted d-block mt-2">Nhập giá trị từ 0 đến 10 (VD: 7.5)</small>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-pencil-alt text-warning"></i> Điểm Giữa Kỳ (30%)
                        </label>
                        <div class="input-group">
                            <input type="number" id="DiemGiuaKy" name="DiemGiuaKy"
                                   class="form-control" step="any" min="0" max="10"
                                   value="@(Model.DiemGiuaKy.HasValue ? Model.DiemGiuaKy.Value.ToString("0.##", System.Globalization.CultureInfo.InvariantCulture) : "")"
                                   placeholder="0.0" />
                            <span class="input-group-text">/10</span>
                        </div>
                        <small class="text-muted d-block mt-2">Nhập giá trị từ 0 đến 10 (VD: 8.5)</small>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-file-alt text-danger"></i> Điểm Cuối Kỳ (60%)
                        </label>
                        <div class="input-group">
                            <input type="number" id="DiemCuoiKy" name="DiemCuoiKy"
                                   class="form-control" step="any" min="0" max="10"
                                   value="@(Model.DiemCuoiKy.HasValue ? Model.DiemCuoiKy.Value.ToString("0.##", System.Globalization.CultureInfo.InvariantCulture) : "")"
                                   placeholder="0.0" />
                            <span class="input-group-text">/10</span>
                        </div>
                        <small class="text-muted d-block mt-2">Nhập giá trị từ 0 đến 10 (VD: 9.0)</small>
                    </div>
                </div>
            </div>

            <hr class="my-4" />

            <div class="row">
                <div class="col-md-12">
                    <div class="card bg-light border-info">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-calculator text-primary"></i> Tính Toán Điểm Tổng Kết
                            </h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="mb-0"><strong>Công thức:</strong></p>
                                    <p class="text-muted small">
                                        Điểm TK = (CC × 10%) + (GK × 30%) + (CK × 60%)
                                    </p>
                                </div>
                                <div class="col-md-6 text-center">
                                    <p class="mb-1"><strong>Điểm Tổng Kết Dự Kiến:</strong></p>
                                    <h2 id="diemDuKien" class="text-primary fw-bold">0.00</h2>
                                    <p id="xepLoaiDuKien" class="mb-0"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <hr class="my-4" />

            <div class="text-end">
                <a href="@Url.Action("Index")" class="btn btn-secondary btn-lg">
                    <i class="fas fa-arrow-left"></i> Quay lại
                </a>
                <button type="reset" class="btn btn-warning btn-lg">
                    <i class="fas fa-redo"></i> Đặt lại
                </button>
                <button type="submit" class="btn btn-success btn-lg">
                    <i class="fas fa-save"></i> Lưu Điểm
                </button>
            </div>
        }
    </div>
</div>

@section scripts {
    <script>
        function getXepLoai(diem) {
            if (diem >= 8.5) return { text: 'Giỏi', class: 'bg-success' };
            if (diem >= 7.0) return { text: 'Khá', class: 'bg-info' };
            if (diem >= 5.5) return { text: 'Trung bình', class: 'bg-warning text-dark' };
            if (diem >= 4.0) return { text: 'Yếu', class: 'bg-secondary' };
            return { text: 'Kém', class: 'bg-danger' };
        }

        function tinhDiemTongKet() {
            const parseNum = val => parseFloat(val.replace(',', '.')) || 0;
            const cc = parseNum(document.getElementById('DiemChuyenCan').value);
            const gk = parseNum(document.getElementById('DiemGiuaKy').value);
            const ck = parseNum(document.getElementById('DiemCuoiKy').value);

            const tongKet = Math.round(((cc * 0.1) + (gk * 0.3) + (ck * 0.6)) * 100) / 100;

            document.getElementById('diemDuKien').textContent = tongKet.toFixed(2);
            const xl = getXepLoai(tongKet);
            document.getElementById('xepLoaiDuKien').innerHTML =
                '<span class="badge ' + xl.class + ' fs-6">' + xl.text + '</span>';
        }

        document.addEventListener('DOMContentLoaded', function () {
            tinhDiemTongKet();

            ['DiemChuyenCan', 'DiemGiuaKy', 'DiemCuoiKy'].forEach(id => {
                document.getElementById(id).addEventListener('input', tinhDiemTongKet);
            });
        });
    </script>
}
