@model IEnumerable<QuanLySinhVien.Models.DiemThongKe>
@{
    ViewBag.Title = "Nhập điểm sinh viên";
}

<div class="row mb-4">
    <div class="col-12">
        <h2 class="page-title">
            <i class="fas fa-edit"></i> Nhập Điểm Sinh Viên
        </h2>
    </div>
</div>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle"></i> @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-circle"></i> @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["InfoMessage"] != null)
{
    <div class="alert alert-info alert-dismissible fade show" role="alert">
        <i class="fas fa-info-circle"></i> @TempData["InfoMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="card">
    <div class="card-header bg-primary text-white">
        <i class="fas fa-search"></i> Bước 1: Chọn sinh viên
    </div>
    <div class="card-body">
        @using (Html.BeginForm("NhapDiem", "Diem", FormMethod.Get))
        {
            <div class="row">
                <div class="col-md-8">
                    <label class="form-label"><strong>Sinh viên:</strong></label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-user-graduate"></i></span>
                        @Html.DropDownList("MaSV",
                            (IEnumerable<SelectListItem>)ViewBag.DanhSachSinhVien,
                            new { @class = "form-select" })
                    </div>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-check"></i> Tải danh sách môn
                    </button>
                </div>
            </div>
        }
    </div>
</div>

@if (ViewBag.DanhSachMonHoc != null && ViewBag.DanhSachMonHoc.Count > 0)
{
    <div class="card mt-3">
        <div class="card-header bg-success text-white">
            <i class="fas fa-pencil-alt"></i> Bước 2: Nhập Điểm - Sinh viên: <strong>@ViewBag.MaSV</strong>
        </div>
        <div class="card-body">
            @using (Html.BeginForm("NhapDiem", "Diem", FormMethod.Post))
            {
                @Html.AntiForgeryToken()
                <input type="hidden" name="MaSV" value="@ViewBag.MaSV" />

                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Hướng dẫn:</strong> Nhập điểm chuyên cần, giữa kỳ, cuối kỳ. Điểm tổng kết sẽ tự động tính: ($\text{ĐCC} \times 10\%$) + ($\text{ĐGK} \times 30\%$) + ($\text{ĐCK} \times 60\%$)
                </div>

                <div class="table-responsive">
                    <table class="table table-bordered table-striped" id="bangDiem">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 12%;">Mã LHP</th>
                                <th style="width: 26%;">Tên môn học</th>
                                <th style="width: 8%;" class="text-center">TC</th>
                                <th style="width: 11%;" class="text-center">Điểm CC (10%)</th>
                                <th style="width: 11%;" class="text-center">Điểm GK (30%)</th>
                                <th style="width: 11%;" class="text-center">Điểm CK (60%)</th>
                                
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                int index = 0;
                                foreach (QuanLySinhVien.Models.DiemThongKe mon in (List<QuanLySinhVien.Models.DiemThongKe>)ViewBag.DanhSachMonHoc)
                                {
                                    <tr class="row-diem" data-index="@index" data-malph="@mon.MaLHP">
                                        <td><strong>@mon.MaLHP</strong></td>
                                        <td>@mon.TenMH</td>
                                        <td class="text-center">
                                            <span class="badge bg-info">@(mon.SoTinChi.GetValueOrDefault(0))</span>
                                        </td>
                                        <td>
                                            <input type="number"
                                                   step="0.1"
                                                   min="0"
                                                   max="10"
                                                   class="form-control form-control-sm diem-input diem-cc"
                                                   id="DiemChuyenCan_@mon.MaLHP"
                                                   name="DiemChuyenCan_@mon.MaLHP"
                                                   value="@(mon.DiemChuyenCan.HasValue ? mon.DiemChuyenCan.Value.ToString("0.0") : "")"
                                                   placeholder="0.0" />
                                        </td>
                                        <td>
                                            <input type="number"
                                                   step="0.1"
                                                   min="0"
                                                   max="10"
                                                   class="form-control form-control-sm diem-input diem-gk"
                                                   id="DiemGiuaKy_@mon.MaLHP"
                                                   name="DiemGiuaKy_@mon.MaLHP"
                                                   value="@(mon.DiemGiuaKy.HasValue ? mon.DiemGiuaKy.Value.ToString("0.0") : "")"
                                                   placeholder="0.0" />
                                        </td>
                                        <td>
                                            <input type="number"
                                                   step="0.1"
                                                   min="0"
                                                   max="10"
                                                   class="form-control form-control-sm diem-input diem-ck"
                                                   id="DiemCuoiKy_@mon.MaLHP"
                                                   name="DiemCuoiKy_@mon.MaLHP"
                                                   value="@(mon.DiemCuoiKy.HasValue ? mon.DiemCuoiKy.Value.ToString("0.0") : "")"
                                                   placeholder="0.0" />
                                        </td>
                                        <td>
                                            <input type="number"
                                                   step="0.01"
                                                   class="form-control form-control-sm diem-tk-display"
                                                   id="DiemTongKet_display_@mon.MaLHP"
                                                   value="@(mon.DiemTongKet.HasValue ? mon.DiemTongKet.Value.ToString("0.00") : "")"
                                                   readonly
                                                   style="background-color: #f0f0f0; font-weight: bold;" />
                                            <input type="hidden"
                                                   id="DiemTongKet_@mon.MaLHP"
                                                   name="DiemTongKet_@mon.MaLHP"
                                                   value="@(mon.DiemTongKet.HasValue ? mon.DiemTongKet.Value.ToString("0.00") : "")" />
                                        </td>
                                    </tr>
                                    index++;
                                }
                            }
                        </tbody>
                    </table>
                </div>

                <hr />

                <div class="text-end">
                    <a href="@Url.Action("NhapDiem")" class="btn btn-secondary btn-lg">
                        <i class="fas fa-times"></i> Hủy
                    </a>
                    <button type="submit" class="btn btn-success btn-lg" id="btnLuu">
                        <i class="fas fa-save"></i> Lưu tất cả điểm
                    </button>
                </div>
            }
        </div>
    </div>
}
else if (!string.IsNullOrEmpty(ViewBag.MaSV))
{
    <div class="alert alert-warning mt-3">
        <i class="fas fa-info-circle"></i>
        <strong>Thông báo:</strong> Sinh viên này không có môn nào cần nhập điểm (tất cả đã có điểm hoặc chưa đăng ký).
    </div>
}
else
{
    <div class="alert alert-info mt-3">
        <i class="fas fa-info-circle"></i>
        <strong>Hướng dẫn:</strong> Chọn sinh viên từ Bước 1 để xem danh sách môn cần nhập điểm
    </div>
}

<script>
    $(document).ready(function () {

        // Sửa: Hàm helper lấy giá trị điểm (xử lý dấu phẩy/chấm)
        function getDiemValue(elementId) {
            // Lấy giá trị và thay thế dấu phẩy bằng dấu chấm
            const val = $('#' + elementId).val().replace(',', '.').trim();
            // Chuyển thành số, nếu không thành công (NaN) thì mặc định là 0
            const num = parseFloat(val);
            return isNaN(num) ? 0 : num;
        }

        // Sửa: Hàm tính điểm tổng kết
        function tinhDiemTongKet(maLHP) {
            // Lấy giá trị, sử dụng hàm helper
            const cc = getDiemValue('DiemChuyenCan_' + maLHP);
            const gk = getDiemValue('DiemGiuaKy_' + maLHP);
            const ck = getDiemValue('DiemCuoiKy_' + maLHP);

            // Sửa: Điều kiện kiểm tra xem người dùng có nhập điểm hay không
            // Tránh trường hợp mặc định là 0 và hiển thị 0.00 khi chưa nhập gì.
            // Ta kiểm tra xem các ô input có chứa giá trị chuỗi (khác rỗng) hay không
            const ccStr = $('#DiemChuyenCan_' + maLHP).val().trim();
            const gkStr = $('#DiemGiuaKy_' + maLHP).val().trim();
            const ckStr = $('#DiemCuoiKy_' + maLHP).val().trim();

            const coNhap = ccStr || gkStr || ckStr;

            if (coNhap) {
                // Đảm bảo các điểm nằm trong phạm vi [0, 10]
                const finalCC = Math.min(10, Math.max(0, cc));
                const finalGK = Math.min(10, Math.max(0, gk));
                const finalCK = Math.min(10, Math.max(0, ck));

                // Tính điểm tổng kết
                const tk = (finalCC * 0.1) + (finalGK * 0.3) + (finalCK * 0.6);
                const tkRounded = tk.toFixed(2); // Làm tròn 2 chữ số thập phân

                $('#DiemTongKet_display_' + maLHP).val(tkRounded);
                $('#DiemTongKet_' + maLHP).val(tkRounded);
            } else {
                // Nếu chưa nhập gì, để trống
                $('#DiemTongKet_display_' + maLHP).val('');
                $('#DiemTongKet_' + maLHP).val('');
            }
        }

        // Khi nhập điểm bất kỳ → tính tổng kết
        $('.diem-input').on('input', function () {
            const tr = $(this).closest('tr');
            const maLHP = tr.data('malph');
            tinhDiemTongKet(maLHP);
        });

        // Tính lại toàn bộ khi load trang (để xử lý trường hợp có sẵn điểm)
        $('#bangDiem tbody tr').each(function () {
            const maLHP = $(this).data('malph');
            tinhDiemTongKet(maLHP);
        });

        // Validation trước khi submit (Giữ nguyên logic kiểm tra đủ 3 điểm và phạm vi)
        $('form').on('submit', function (e) {
            let coLoi = false;
            let thongBao = '';

            $('#bangDiem tbody tr').each(function () {
                const maLHP = $(this).data('malph');

                // Lấy giá trị chuỗi gốc để kiểm tra "có nhập hay không"
                [cite_start]const ccStr = $('#DiemChuyenCan_' + maLHP).val().trim();[cite: 58]
                const gkStr = $('#DiemGiuaKy_' + maLHP).val().trim();
                const ckStr = $('#DiemCuoiKy_' + maLHP).val().trim();

                const coNhap = ccStr || gkStr || ckStr;
                const duBa = ccStr && gkStr && ckStr;

                // Lấy giá trị số đã làm sạch để kiểm tra phạm vi (Sử dụng hàm getDiemValue mới)
                const cc = getDiemValue('DiemChuyenCan_' + maLHP);
                const gk = getDiemValue('DiemGiuaKy_' + maLHP);
                const ck = getDiemValue('DiemCuoiKy_' + maLHP);

                [cite_start]if (coNhap && !duBa) {
                    [cite: 59]
                    coLoi = true;
                    thongBao += '• Môn ' + maLHP + ': Vui lòng nhập đủ 3 điểm (CC, GK, CK) hoặc không nhập gì\n';
                }

                [cite_start]if (ccStr && (cc < 0 || cc > 10)) {
                    [cite: 60]
                    coLoi = true;
                    [cite_start]thongBao += '• Môn ' + maLHP + ': Điểm CC phải từ 0-10\n';[cite: 60]
                }
                [cite_start]if (gkStr && (gk < 0 || gk > 10)) {
                    [cite: 61]
                    coLoi = true;
                    [cite_start]thongBao += '• Môn ' + maLHP + ': Điểm GK phải từ 0-10\n';[cite: 62]
                }
                [cite_start]if (ckStr && (ck < 0 || ck > 10)) {
                    [cite: 63]
                    coLoi = true;
                    [cite_start]thongBao += '• Môn ' + maLHP + ': Điểm CK phải từ 0-10\n';[cite: 63]
                }
            });

            [cite_start]if (coLoi) {
                [cite: 65]
                alert('❌ Lỗi nhập điểm:\n\n' + thongBao);
                [cite_start]e.preventDefault();[cite: 66]
                return false;
            }

            if (!confirm('✅ Bạn chắc chắn muốn lưu điểm?')) {
                [cite_start]e.preventDefault();[cite: 67]
                return false;
            }

            [cite_start]$('#btnLuu').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Đang lưu...');[cite: 68]
        });
    });
</script>

<style>
    [cite_start].table-bordered td {
        [cite: 69] vertical-align: middle;
        [cite_start]padding: 8px;
        [cite: 69]
    }

    .form-control-sm {
        [cite_start]font-size: 0.9rem;
        [cite: 70] [cite_start]padding: 0.4rem 0.5rem;
        [cite: 70]
    }

    .diem-input:focus {
        [cite_start]border-color: #667eea;
        [cite: 71] [cite_start]box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        [cite: 71]
    }

    .diem-tk-display {
        [cite_start]background-color: #f0f0f0 !important;
        [cite: 72] [cite_start]font-weight: bold;
        [cite: 72] cursor: not-allowed;
    }

    table tbody tr:hover {
        [cite_start]background-color: #f5f5f5;
        [cite: 73] [cite_start]transition: background-color 0.2s;
        [cite: 73]
    }
</style>