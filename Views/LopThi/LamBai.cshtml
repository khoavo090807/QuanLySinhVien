@model QuanLySinhVien.Models.BaiThiViewModel

@{
    ViewBag.Title = "Làm Bài Thi";
}

<div class="row mb-3">
    <div class="col-12">
        <div class="card bg-light">
            <div class="card-body">
                <h5>
                    <i class="fas fa-exam"></i> @Model.TenDeThi
                    <span class="float-end">
                        <span class="badge bg-primary">Câu: @Model.TongCau</span>
                        <span class="badge bg-info">Thời gian: @Model.ThoiGianLamBai phút</span>
                    </span>
                </h5>
                <div id="countdown" class="mt-2" style="font-size: 18px; color: red;">
                    <i class="fas fa-hourglass-end"></i> Thời gian còn lại: <strong id="timeLeft">@Model.ThoiGianLamBai:00</strong>
                </div>
            </div>
        </div>
    </div>
</div>

@using (Html.BeginForm("NopBai", "LopThi", FormMethod.Post, new { id = "formBaiThi" }))
{
    @Html.AntiForgeryToken()
    <input type="hidden" name="maLopThi" value="@Model.MaLopThi" />
    <input type="hidden" name="maDT" value="@Model.MaDT" />

    <div class="row">
        @for (int i = 0; i < Model.DanhSachCau.Count; i++)
        {
            var cau = Model.DanhSachCau[i];
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header">
                        <strong>Câu @cau.ThuTu</strong>
                        <span class="float-end badge bg-success">@cau.Diem điểm</span>
                    </div>
                    <div class="card-body">
                        <p>@cau.NoiDung</p>

                        <div class="mb-2">
                            <label class="form-check">
                                <input type="radio" name="dapAn[@cau.MaCau]" value="A" class="form-check-input" />
                                <span class="form-check-label"><strong>A.</strong> @cau.DapAnA</span>
                            </label>
                        </div>

                        <div class="mb-2">
                            <label class="form-check">
                                <input type="radio" name="dapAn[@cau.MaCau]" value="B" class="form-check-input" />
                                <span class="form-check-label"><strong>B.</strong> @cau.DapAnB</span>
                            </label>
                        </div>

                        <div class="mb-2">
                            <label class="form-check">
                                <input type="radio" name="dapAn[@cau.MaCau]" value="C" class="form-check-input" />
                                <span class="form-check-label"><strong>C.</strong> @cau.DapAnC</span>
                            </label>
                        </div>

                        <div class="mb-2">
                            <label class="form-check">
                                <input type="radio" name="dapAn[@cau.MaCau]" value="D" class="form-check-input" />
                                <span class="form-check-label"><strong>D.</strong> @cau.DapAnD</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>

    <div class="text-center mt-4">
        <button type="submit" class="btn btn-lg btn-success" id="btnNopBai">
            <i class="fas fa-check"></i> Nộp Bài Thi
        </button>
    </div>
}

<script>
    // Countdown timer
    let timeLeft = @Model.ThoiGianLamBai * 60;

    setInterval(function () {
        timeLeft--;

        let minutes = Math.floor(timeLeft / 60);
        let seconds = timeLeft % 60;

        document.getElementById('timeLeft').textContent =
            (minutes < 10 ? '0' : '') + minutes + ':' +
            (seconds < 10 ? '0' : '') + seconds;

        if (timeLeft <= 0) {
            document.getElementById('formBaiThi').submit();
        }

        // Đổi màu khi còn 5 phút
        if (timeLeft <= 300) {
            document.getElementById('countdown').style.color = 'orange';
        }

        // Đổi màu khi còn 1 phút
        if (timeLeft <= 60) {
            document.getElementById('countdown').style.color = 'red';
        }
    }, 1000);

    // Confirm before submit
    document.getElementById('btnNopBai').addEventListener('click', function (e) {
        if (!confirm('Bạn có chắc chắn muốn nộp bài? Bạn sẽ không thể chỉnh sửa sau đó!')) {
            e.preventDefault();
        }
    });
</script>